<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <title>GENIVI SOTA Project : Deployment with Docker Launcher</title>
        <meta name="description" content="Software Updates Over the Air">

        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/rvi_sota_server/css/main.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
    </head>
    <body>

        <div class="container-fluid">
            <div class="row">
                <div id="header" class="col-sm-12">
                    <h4><img src="/rvi_sota_server/images/icon-logo.png"> <a class="brand" href="/rvi_sota_server/">GENIVI SOTA Project</a> / 
    Software Updates Over the Air
</h4>

                </div>
            </div>

            <div class="row">
                
                
                    <div id="navigation" class="col-sm-3">
                        <ul class="nav nav-list">
    <li><a href="/rvi_sota_server/">Home</a></li>
    
        
        

        
            
                <li class="nav-header">Documentation</li>
            
            <li data-order="2"><a href="/rvi_sota_server/doc/deployment-with-docker-launcher.html">Deployment with Docker Launcher</a></li>
        
            
            <li data-order="6"><a href="/rvi_sota_server/doc/contributing.html">Contributing</a></li>
        
            
            <li data-order="3"><a href="/rvi_sota_server/doc/admin-gui-user-guide.html">Admin GUI User Guide</a></li>
        
            
            <li data-order="1"><a href="/rvi_sota_server/doc/building-installing.html">Building & Deploying</a></li>
        
    
        
        

        
            
                <li class="nav-header">Security</li>
            
            <li data-order=""><a href="/rvi_sota_server/sec/security-threats-mitigations.html">Security Threats & Mitigations</a></li>
        
            
            <li data-order=""><a href="/rvi_sota_server/sec/whitelisted-interactions.html">Whitelisted Interactions</a></li>
        
    
        
        

        
            
                <li class="nav-header">Reference</li>
            
            <li data-order=""><a href="/rvi_sota_server/ref/dependencies.html">Dependencies</a></li>
        
            
            <li data-order="5"><a href="/rvi_sota_server/ref/use-cases.html">Use Cases</a></li>
        
            
            <li data-order="4"><a href="/rvi_sota_server/ref/requirements.html">Requirements</a></li>
        
    
        
        

        
            
                <li class="nav-header">Developers</li>
            
            <li data-order="6"><a href="/rvi_sota_server/dev/client-implementation-example-session.html">Client Implementation Example Session</a></li>
        
            
            <li data-order="5"><a href="/rvi_sota_server/dev/client-implementation.html">Client Implementation Reference</a></li>
        
            
            <li data-order="2"><a href="/rvi_sota_server/dev/architecture.html">SOTA Architecture</a></li>
        
            
            <li data-order="4"><a href="/rvi_sota_server/dev/database-style-guide.html">Database Style Guide</a></li>
        
            
            <li data-order="3"><a href="/rvi_sota_server/dev/scala-style-guide.html">Scala Style Guide</a></li>
        
            
            <li data-order="1"><a href="/rvi_sota_server/dev/api.html">API</a></li>
        
    
<!-- List additional links. It is recommended to add a divider
    e.g. <li class="divider"></li> first to break up the content. -->
</ul>

                    </div>

                    <div id="content" class="col-sm-9">
                        <div id="content" class="col-sm-10">
                            <div class="page-header">
    <h2>Deployment with Docker Launcher
        
    </h2>
</div>

<div class="paragraph">
<p>Docker Launcher launches projects using Docker and Ansible. It is a prerequisite for deploying the SOTA server, and can be installed from <a href="https://github.com/advancedtelematic/docker-launcher">its GitHub repository.</a></p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Please ensure you are using the latest version of Docker Launcher. Older versions may not correctly deploy the SOTA Server.
</td>
</tr>
</table>
</div>
<div class="sect1">
<h2 id="prerequisites">Prerequisites</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="basic-software-packages">Basic Software Packages</h3>
<div class="paragraph">
<p>You will need curl, python, and the following three python packages: <code>ansible</code>, <code>boto</code>, and <code>docker-py</code>. The python packages may be installed by running <code>sudo pip install ansible boto docker-py</code></p>
</div>
</div>
<div class="sect2">
<h3 id="docker-hub">Docker Hub</h3>
<div class="paragraph">
<p>You will need a Docker Hub account (<a href="https://hub.docker.com/" class="bare">https://hub.docker.com/</a>).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploying-a-development-system">Deploying a Development System</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To deploy a local development system, there are 3 basic steps.</p>
</div>
<div class="sect2">
<h3 id="1-build-the-local-docker-images">1. Build the local docker images</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">./sbt docker:publishLocal</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once this completes successfully, you may deploy with <a href="https://github.com/advancedtelematic/docker-launcher">Docker Launcher.</a></p>
</div>
</div>
<div class="sect2">
<h3 id="2-launch-the-docker-images-with-docker-launcher">2. Launch the docker images with docker-launcher</h3>
<div class="paragraph">
<p>For deploying a development system to your local machine, make sure you have Docker Launcher and Docker installed and configured to your liking. Docker Launcher currently requires Docker &gt;= v.1.8.0 and Ansible v.1.9.2. Ansible 2.x has not yet been tested, and is not guaranteed to work.</p>
</div>
<div class="paragraph">
<p>First, enter the <code>deploy</code> directory, and copy the example Docker Launcher configuration file, then edit it to match your preferences. The only values you should need to change are the <code>user</code> and <code>email</code> fields in <code>docker-launcher.yml</code>. These should be a valid username and associated email address for Docker Hub.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span style="color: #008000">cd </span>deploy
cp docker-launcher.yml.example docker-launcher.yml
docker-launcher -c docker-launcher.yml deploy-sota-local.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will be prompted for your Docker Hub password, but for a local deployment it&#8217;s not actually needed.</p>
</div>
</div>
<div class="sect2">
<h3 id="3-apply-database-migrations-to-the-newly-created-mariadb-container">3. Apply database migrations to the newly created MariaDB container</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span style="color: #19177C">CORE_DB_URL</span><span style="color: #666666">=</span>jdbc:mariadb://&lt;your-docker-host&gt;:3306/sota_core <span style="color: #19177C">RESOLVER_DB_URL</span><span style="color: #666666">=</span>jdbc:mariadb://&lt;your-docker-host&gt;:3306/sota_resolver sbt flywayMigrate</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="teardown">Teardown</h3>
<div class="paragraph">
<p>To stop the running system, run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">docker-launcher --teardown -c docker-launcher.yml deploy-sota-local.yml</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Teardown does not wipe the database; there is a <code>sota-data</code> container for persistent database storage. If you wish to start over with a clean database, you can remove this container with <code>docker rm -v sota-data</code>, and run docker-launcher again to recreate it.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cistaging-remote-system">CI/Staging remote system</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For deploying a remote system for staging and CI, with a docker daemon accessible from a single IP run</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span style="color: #008000">cd </span>deploy/sota-docker-hub
ansible-playbook -i inventory launch-docker-hub.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll get prompted for the IP you want to allow to connect to the docker daemon.</p>
</div>
<div class="paragraph">
<p><strong>NOTE:</strong> This depends on a properly configured <code>docker-launcher.yml</code>, even though it is not using Docker Launcher.</p>
</div>
<div class="paragraph">
<p>To connect to the remote instance, find its IP from AWS Console and prepend your docker commands with <code>-H tcp://&lt;Address-of-staging-system&gt;:2375</code> like this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">docker -H tcp://&lt;Address-of-staging-system&gt;:2375 build -t something .</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="deploying-against-the-staging-system">Deploying against the staging system</h3>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span style="color: #008000">export </span><span style="color: #19177C">DOCKER_HOST</span><span style="color: #666666">=</span>tcp://&lt;Address-of-staging-system&gt;:2375
docker-launcher -c deploy/docker-launcher.yml deploy/deploy-sota-local.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>For migrations you need to tell flyway the connection details like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh"><span style="color: #19177C">CORE_DB_USER</span><span style="color: #666666">=</span>&lt;user&gt; <span style="color: #19177C">CORE_DB_PASSWORD</span><span style="color: #666666">=</span>&lt;password&gt; <span style="color: #19177C">CORE_DB_URL</span><span style="color: #666666">=</span>jdbc:mysql://&lt;host&gt;:3306/sota sbt core/flywayMigrate</code></pre>
</div>
</div>
<div class="paragraph">
<p>With <code>&lt;user&gt;</code>, <code>&lt;password&gt;</code>, and <code>&lt;host&gt;</code> replaced with suitable values.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploying-to-amazon-aws">Deploying to Amazon AWS</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="aws-prerequisites">AWS Prerequisites</h3>
<div class="paragraph">
<p>Deployment of rvi-sota-server requires valid AWS administrator credentials, as well as an SSH key to administer any instances launched by the vw-garage deployment scripts.</p>
</div>
<div class="sect3">
<h4 id="create-new-user-for-deployment">Create New User for Deployment</h4>
<div class="paragraph">
<p>For security purposes, we recommend creating a new IAM user to manage the deployment. This user will have full access to the AWS services, but will not have the capability to create new users. If the credentials for the <strong>deploy</strong> user are compromised, they can be reset using the root AWS account.</p>
</div>
<div class="sect4">
<h5 id="save-user-credentials">Save User Credentials</h5>
<div class="paragraph">
<p>Once the user has been created, you should download the credentials. Be careful! You will only have one opportunity to do this. Once you have them, create a file in your home directory called <code>~/.boto</code>. It should look like this (with the angle brackets omitted):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[Credentials]
aws_access_key_id = &lt;your deploy user's access key id&gt;
aws_secret_access_key = &lt;your deploy user's secret access key&gt;</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="set-user-security-policy">Set User Security Policy</h5>
<div class="paragraph">
<p>We recommend attaching the <code>PowerUserAccess</code> policy to the <strong>deploy</strong> user.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="ssh-keypair">SSH Keypair</h4>
<div class="paragraph">
<p>You will need an SSH keypair available in the AWS region you wish to install to (eu-west-1 by default). Full documentation for key pairs is available from the <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-key-pairs.html">AWS Website</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="deploying-with-docker-launcher">Deploying with docker-launcher</h3>
<div class="paragraph">
<p>To deploy to AWS, you will need to configure <code>docker-launcher.yml</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml">reboot_strategy: <span style="color: #BA2121">&#39;best-effort&#39;</span>
registry:
  user: atsjenkins <i class="conum" data-value="1"></i><b>(1)</b>
  email: jenkins@advancedtelematic.com <i class="conum" data-value="2"></i><b>(2)</b>
ec2:
  key: tauron <i class="conum" data-value="3"></i><b>(3)</b>
  image: ami-07fd8270 <i class="conum" data-value="4"></i><b>(4)</b>
  region: eu-west-1 <i class="conum" data-value="5"></i><b>(5)</b>

vars:
  db_root_password: <span style="color: #BA2121">&quot;sota-test&quot;</span>
  db_user: <span style="color: #BA2121">&quot;sota&quot;</span>
  db_user_password: <span style="color: #BA2121">&quot;s0ta&quot;</span>
  db_resolver_name: <span style="color: #BA2121">&quot;sota_resolver&quot;</span>
  db_core_name: <span style="color: #BA2121">&quot;sota_core&quot;</span>
  play_crypto_secret: <span style="color: #BA2121">&quot;YM5B6o&lt;ywKn4tTyA;tOZ&lt;2xUEajF4DDi=O/PPm1Q^w2LqtKISd9oqYT6b&gt;&gt;C1gQa&quot;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You will need to change at least three values from the example file:</p>
</div>
<div id="code_list" class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Your username at Docker Hub</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The email address associated with your Docker Hub account</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The name of an SSH keypair associated with your AWS account</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You may wish to also change the region (5). Note that if you do so, you will need to select a CoreOS image (4) valid for <code>c3.xlarge</code> instances in your chosen region. If you don&#8217;t change the region, the default from the example file should work.</p>
</div>
<div class="paragraph">
<p>Once you&#8217;ve configured <code>docker-launcher.yml</code> to your liking, you can run <code>docker-launcher -c docker-launcher.yml deploy-sota-ec2.yml</code> to deploy to AWS. Note that this may take quite some time. You can set debug verbosity in docker-launcher with <code>-vvv</code>.</p>
</div>
</div>
</div>
</div>

                        </div>
                    </div>
                
            </div>

            

            <div class="row">
                <div id="footer" class="col-sm-12">
                    Documentation for <a href="https://github.com/PDXostc/rvi_sota_server">GENIVI SOTA Project</a>

                </div>
            </div>
        </div>

        <script>
            function orderNav() {
                var list,
                    section,
                    header,
                    sections = [],
                    lists = {},
                    headers = {};

                var navUl = document.querySelectorAll('#navigation ul')[0],
                    navLis = document.querySelectorAll('#navigation ul li');

                if (!navUl) return;

                for (var i = 0; i < navLis.length; i++) {
                    var order, li = navLis[i];

                    if (li.classList.contains('nav-header')) {
                        section = li.textContent || li.innerText;
                        sections.push(section);
                        headers[section] = li;
                        continue;
                    }

                    if (!lists[section]) {
                        lists[section] = [];
                    }

                    order = parseFloat(li.getAttribute('data-order'))
                    lists[section].push([order, li]);
                }

                for (var i = 0; i < sections.length; i++) {
                    section = sections[i];
                    list = lists[section].sort(function(a, b) {
                        return a[0] - b[0];
                    });

                    if (header = headers[section]) {
                        navUl.appendChild(header);
                    }
                    for (var j = 0; j < list.length; j++) {
                        navUl.appendChild(list[j][1]);
                    }
                }
            }

            if (document.querySelectorAll) orderNav();
        </script>
        
        <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-69301419-1', 'auto');
  ga('send', 'pageview');
</script>

        
    </body>
</html>
