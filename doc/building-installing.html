<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <title>GENIVI SOTA Project : Building & Deploying</title>
        <meta name="description" content="Software Updates Over the Air">

        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/rvi_sota_server/css/main.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css">
    </head>
    <body>

        <div class="container-fluid">
            <div class="row">
                <div id="header" class="col-sm-12">
                    <h4><img src="/rvi_sota_server/images/icon-logo.png"> <a class="brand" href="/rvi_sota_server/">GENIVI SOTA Project</a> / 
    Software Updates Over the Air
</h4>

                </div>
            </div>

            <div class="row">
                
                
                    <div id="navigation" class="col-sm-3">
                        <ul class="nav nav-list">
    <li><a href="/rvi_sota_server/">Home</a></li>
    
        
        

        
            
                <li class="nav-header">Documentation</li>
            
            <li data-order="2"><a href="/rvi_sota_server/doc/deployment-with-docker-launcher.html">Deployment with Docker Launcher</a></li>
        
            
            <li data-order="6"><a href="/rvi_sota_server/doc/contributing.html">Contributing</a></li>
        
            
            <li data-order="3"><a href="/rvi_sota_server/doc/admin-gui-user-guide.html">Admin GUI User Guide</a></li>
        
            
            <li data-order="1"><a href="/rvi_sota_server/doc/building-installing.html">Building & Deploying</a></li>
        
    
        
        

        
            
                <li class="nav-header">Security</li>
            
            <li data-order=""><a href="/rvi_sota_server/sec/security-threats-mitigations.html">Security Threats & Mitigations</a></li>
        
            
            <li data-order=""><a href="/rvi_sota_server/sec/whitelisted-interactions.html">Whitelisted Interactions</a></li>
        
    
        
        

        
            
                <li class="nav-header">Reference</li>
            
            <li data-order=""><a href="/rvi_sota_server/ref/dependencies.html">Dependencies</a></li>
        
            
            <li data-order="5"><a href="/rvi_sota_server/ref/use-cases.html">Use Cases</a></li>
        
            
            <li data-order="4"><a href="/rvi_sota_server/ref/requirements.html">Requirements</a></li>
        
    
        
        

        
            
                <li class="nav-header">Developers</li>
            
            <li data-order="6"><a href="/rvi_sota_server/dev/client-implementation-example-session.html">Client Implementation Example Session</a></li>
        
            
            <li data-order="5"><a href="/rvi_sota_server/dev/client-implementation.html">Client Implementation Reference</a></li>
        
            
            <li data-order="2"><a href="/rvi_sota_server/dev/architecture.html">SOTA Architecture</a></li>
        
            
            <li data-order="4"><a href="/rvi_sota_server/dev/database-style-guide.html">Database Style Guide</a></li>
        
            
            <li data-order="3"><a href="/rvi_sota_server/dev/scala-style-guide.html">Scala Style Guide</a></li>
        
            
            <li data-order="1"><a href="/rvi_sota_server/dev/api.html">API</a></li>
        
    
<!-- List additional links. It is recommended to add a divider
    e.g. <li class="divider"></li> first to break up the content. -->
</ul>

                    </div>

                    <div id="content" class="col-sm-9">
                        <div id="content" class="col-sm-10">
                            <div class="page-header">
    <h2>Building & Deploying
        
    </h2>
</div>

<div class="paragraph">
<p>For the server-side components, this project includes a <a href="https://github.com/advancedtelematic/docker-launcher">docker-launcher</a> configuration file to allow the cluster of components to be deployed conveniently to a developer machine or to Amazon AWS. See <a href="../doc/deployment-with-docker-launcher.html">Deployment with Docker Launcher</a> for deploying a development or evaluation system with Docker Launcher.</p>
</div>
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#building-rvi_sota_server-locally">Building rvi_sota_server Locally</a>
<ul class="sectlevel2">
<li><a href="#prerequisite-java">Prerequisite: Java</a></li>
<li><a href="#prerequisite-mariadb">Prerequisite: MariaDB</a></li>
<li><a href="#prerequisite-rvi-server-node">Prerequisite: RVI server node</a></li>
<li><a href="#running-the-server">Running the server</a></li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
<li><a href="#database-migrations">Database Migrations</a></li>
</ul>
</li>
<li><a href="#building-rvi_sota_client-locally">Building rvi_sota_client Locally</a>
<ul class="sectlevel2">
<li><a href="#building-and-running-rvi-nodes">Building and running RVI nodes</a></li>
<li><a href="#building-and-running-sota-client">Building and running SOTA client</a></li>
</ul>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="building-rvi_sota_server-locally">Building rvi_sota_server Locally</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For local development, the following prerequisites are required:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Java 8</p>
</li>
<li>
<p>MariaDB (with appropriate databases created)</p>
</li>
<li>
<p>An RVI server node</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The other dependencies are managed using Scala&#8217;s <code>sbt</code>. If you have sbt installed then use it, otherwise the <code>./sbt</code> script in the root of the project will bootstrap everything you need beyond Java 8.</p>
</div>
<div class="sect2">
<h3 id="prerequisite-java">Prerequisite: Java</h3>
<div class="paragraph">
<p>To check the version of java installed, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code># java -version
java version "1.8.0_45"
Java(TM) SE Runtime Environment (build 1.8.0_45-b14)
Java HotSpot(TM) 64-Bit Server VM (build 25.45-b02, mixed mode)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="prerequisite-mariadb">Prerequisite: MariaDB</h3>
<div class="paragraph">
<p>For development, a local MariaDB install is required. (Note that this is <strong>not</strong> required for deployment, as Docker Launcher will handle the creation of the database. If a Docker Launcher local deployment is attempted on a machine already running a database instance, there may be conflicts.) Create two databases called 'sota_core' and 'sota_resolver':</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql">mysql <span style="color: #666666">-</span>u root <span style="color: #666666">-</span>p
<span style="color: #008000; font-weight: bold">CREATE</span> <span style="color: #008000; font-weight: bold">DATABASE</span> sota_core;
<span style="color: #008000; font-weight: bold">CREATE</span> <span style="color: #008000; font-weight: bold">DATABASE</span> sota_core_test;
<span style="color: #008000; font-weight: bold">CREATE</span> <span style="color: #008000; font-weight: bold">DATABASE</span> sota_resolver;
<span style="color: #008000; font-weight: bold">CREATE</span> <span style="color: #008000; font-weight: bold">DATABASE</span> sota_resolver_test;
<span style="color: #008000; font-weight: bold">CREATE</span> <span style="color: #008000; font-weight: bold">USER</span> <span style="color: #BA2121">&#39;sota&#39;</span><span style="color: #666666">@</span><span style="color: #BA2121">&#39;localhost&#39;</span> IDENTIFIED <span style="color: #008000; font-weight: bold">BY</span> <span style="color: #BA2121">&#39;s0ta&#39;</span>;
<span style="color: #008000; font-weight: bold">GRANT</span> <span style="color: #008000; font-weight: bold">ALL</span> <span style="color: #008000; font-weight: bold">PRIVILEGES</span> <span style="color: #008000; font-weight: bold">ON</span> sota_core . <span style="color: #666666">*</span> <span style="color: #008000; font-weight: bold">TO</span> <span style="color: #BA2121">&#39;sota&#39;</span><span style="color: #666666">@</span><span style="color: #BA2121">&#39;localhost&#39;</span>;
<span style="color: #008000; font-weight: bold">GRANT</span> <span style="color: #008000; font-weight: bold">ALL</span> <span style="color: #008000; font-weight: bold">PRIVILEGES</span> <span style="color: #008000; font-weight: bold">ON</span> sota_core_test . <span style="color: #666666">*</span> <span style="color: #008000; font-weight: bold">TO</span> <span style="color: #BA2121">&#39;sota&#39;</span><span style="color: #666666">@</span><span style="color: #BA2121">&#39;localhost&#39;</span>;
<span style="color: #008000; font-weight: bold">GRANT</span> <span style="color: #008000; font-weight: bold">ALL</span> <span style="color: #008000; font-weight: bold">PRIVILEGES</span> <span style="color: #008000; font-weight: bold">ON</span> sota_resolver . <span style="color: #666666">*</span> <span style="color: #008000; font-weight: bold">TO</span> <span style="color: #BA2121">&#39;sota&#39;</span><span style="color: #666666">@</span><span style="color: #BA2121">&#39;localhost&#39;</span>;
<span style="color: #008000; font-weight: bold">GRANT</span> <span style="color: #008000; font-weight: bold">ALL</span> <span style="color: #008000; font-weight: bold">PRIVILEGES</span> <span style="color: #008000; font-weight: bold">ON</span> sota_resolver_test . <span style="color: #666666">*</span> <span style="color: #008000; font-weight: bold">TO</span> <span style="color: #BA2121">&#39;sota&#39;</span><span style="color: #666666">@</span><span style="color: #BA2121">&#39;localhost&#39;</span>;
FLUSH <span style="color: #008000; font-weight: bold">PRIVILEGES</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To update the database schema, run <code>sbt flywayMigrate</code></p>
</div>
<div class="paragraph">
<p>This will apply any new migrations in src/main/resources/db/migration, and keep your existing data. This command expects to find the databases on localhost with sota/s0ta for the username/password. The URL to the database and login details can be overridden with the <code>CORE_DB_URL</code>, <code>CORE_DB_USER</code> and <code>CORE_DB_PASSWORD</code> environment variables for the core and <code>RESOLVER_DB_URL</code>, <code>RESOLVER_DB_USER</code> and, <code>RESOLVER_DB_PASSWORD</code> for the external resolver. See <code>project/SotaBuild.scala</code> for the implementation.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you are having trouble with flywayMigrate after an update, try deleting the sota_core, sota_core_test, sota_resolver, and sota_resolver_test databases, recreating them with the commands above, and running flywayMigrate again.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="prerequisite-rvi-server-node">Prerequisite: RVI server node</h3>
<div class="paragraph">
<p>All client-server communications are done using the <a href="https://github.com/PDXostc/rvi_core">RVI protocol</a>, and the SOTA Core Server requires an active RVI Server Node to run. The easiest way get an RVI node suitable for SOTA up and running is to use our docker images:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">docker pull advancedtelematic/rvi
docker run -it --name rvi-server --expose <span style="color: #666666">8801</span> --expose 8805-8808 -p 8801:8801 -p 8805:8805 -p 8806:8806 -p 8807:8807 -p 8808:8808 advancedtelematic/rvi server</code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Building without an active RVI node</div>
<div class="paragraph">
<p>If you don&#8217;t need to worry about the client communication part of the server, you might not want to bother with setting up an RVI node. You can get around this requirement by editing line 57 of <code>/core/src/main/scala/org/genivi/sota/core/Boot.scala</code> to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="scala">sotaServices <span style="color: #008000; font-weight: bold">&lt;-</span> <span style="color: #0000FF; font-weight: bold">FastFuture</span><span style="color: #666666">.</span>successful<span style="color: #666666">(</span><span style="color: #0000FF; font-weight: bold">ServerServices</span><span style="color: #666666">(</span><span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">,</span><span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">,</span><span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">,</span><span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">,</span><span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">))</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="running-the-server">Running the server</h3>
<div class="paragraph">
<p>Once flywayMigrate has run, open three consoles and run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sh">sbt resolver/run
sbt core/run
sbt webserver/run</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The SOTA Core server looks for the RVI server node on localhost by default. If your RVI node is running somewhere else (i.e. if you&#8217;re running docker on a mac), you will need to specify <code>RVI_URI</code> as an environment variable. If your docker host was 192.168.99.100, for example, you would run <code>RVI_URI="http://192.168.99.100:8801" sbt core/run</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now open <a href="http://localhost:9000/">localhost:9000</a> in a browser.</p>
</div>
</div>
<div class="sect2">
<h3 id="troubleshooting">Troubleshooting</h3>
<div class="paragraph">
<p>If you are using an encrypted home directory, you may get the following error when attempting a build. This is because scala/sbt tends to create long file names, and these get expanded even further by ecryptfs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[error] File name too long
[error] one error found
[error] (core/compile:compileIncremental) Compilation failed
[error] Total time: 9 s, completed Jul 24, 2015 9:10:13 AM</pre>
</div>
</div>
<div class="paragraph">
<p>The solution is to point the build directories to somewhere outside ecryptfs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>sudo mkdir /var/sota-build
sudo chown `whoami` /var/sota-build/
mkdir /var/sota-build/core-target
mkdir /var/sota-build/resolver-target
mkdir /var/sota-build/webserver-target
rm -r core/target/
rm -r external-resolver/target
rm -r web-server/target
ln -s /var/sota-build/core-target/ core/target
ln -s /var/sota-build/resolver-target external-resolver/target
ln -s /var/sota-build/webserver-target/ web-server/target</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="database-migrations">Database Migrations</h3>
<div class="paragraph">
<p>Never make changes to migrations that already exist. Add columns by creating a new migration with an 'ALTER TABLE' statement.</p>
</div>
<div class="paragraph">
<p>If someone else has added a migration, run <code>sbt flywayMigrate</code> to update your local database.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="building-rvi_sota_client-locally">Building rvi_sota_client Locally</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To see the <a href="https://github.com/PDXostc/rvi_sota_client">SOTA client</a> in action, you will need some supporting components running. The general steps are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Build and run RVI server and client nodes</p>
</li>
<li>
<p>Build and run rvi_sota_client</p>
</li>
<li>
<p>Build and run rvi_sota_demo</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="building-and-running-rvi-nodes">Building and running RVI nodes</h3>
<div class="paragraph">
<p>You can build RVI directly from <a href="https://github.com/PDXostc/rvi_core">its GitHub repo</a>, or simply run our docker image. These instructions assume you are running the docker image.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Pull the image: <code>docker pull advancedtelematic/rvi</code>.</p>
</li>
<li>
<p>In two terminal windows, run the rvi client and server nodes</p>
<div class="ulist">
<ul>
<li>
<p>Client: <code>docker run -it --name rvi-client --expose 8901 --expose 8905-8908 -p 8901:8901 -p 8905:8905 -p 8906:8906 -p 8907:8907 -p 8908:8908 advancedtelematic/rvi client</code></p>
</li>
<li>
<p>Server: <code>docker run -it --name rvi-server --expose 8801 --expose 8805-8808 -p 8801:8801 -p 8805:8805 -p 8806:8806 -p 8807:8807 -p 8808:8808 advancedtelematic/rvi server</code></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="building-and-running-sota-client">Building and running SOTA client</h3>
<div class="paragraph">
<p>The SOTA client builds as a docker container. As long as you have <code>rust</code> and <code>cargo</code> installed, <code>make docker</code> should build a docker image called <code>sota-client</code>.</p>
</div>
<div class="paragraph">
<p>You can also build the SOTA client from within a docker container; this will be necessary if your build environment is not running linux. From the project root, run <code>docker run -it --rm -v $PWD:/build advancedtelematic/rust:latest /bin/bash</code>. Once you are at a bash prompt, run the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>apt-get update
apt-get install -y libssl-dev dbus libdbus-1-dev dbus-1-dbg make
cd /build
cargo build --release
exit</pre>
</div>
</div>
<div class="paragraph">
<p>Now you can run <code>make docker</code> from your normal build environment.</p>
</div>
<div class="paragraph">
<p>Once the sota-client docker image is built (by either of the two methods above), you can run it with <code>docker run -it --name sota-client -p 9000:9000 --link rvi-client:rvi-client -e RUST_LOG=info advancedtelematic/sota-client</code>.</p>
</div>
<div class="paragraph">
<p>The client will listen for an active campaign from the server, and download updates when they become available. It then uses dbus calls to install the package it received.</p>
</div>
</div>
</div>
</div>

                        </div>
                    </div>
                
            </div>

            

            <div class="row">
                <div id="footer" class="col-sm-12">
                    Documentation for <a href="https://github.com/PDXostc/rvi_sota_server">GENIVI SOTA Project</a>

                </div>
            </div>
        </div>

        <script>
            function orderNav() {
                var list,
                    section,
                    header,
                    sections = [],
                    lists = {},
                    headers = {};

                var navUl = document.querySelectorAll('#navigation ul')[0],
                    navLis = document.querySelectorAll('#navigation ul li');

                if (!navUl) return;

                for (var i = 0; i < navLis.length; i++) {
                    var order, li = navLis[i];

                    if (li.classList.contains('nav-header')) {
                        section = li.textContent || li.innerText;
                        sections.push(section);
                        headers[section] = li;
                        continue;
                    }

                    if (!lists[section]) {
                        lists[section] = [];
                    }

                    order = parseFloat(li.getAttribute('data-order'))
                    lists[section].push([order, li]);
                }

                for (var i = 0; i < sections.length; i++) {
                    section = sections[i];
                    list = lists[section].sort(function(a, b) {
                        return a[0] - b[0];
                    });

                    if (header = headers[section]) {
                        navUl.appendChild(header);
                    }
                    for (var j = 0; j < list.length; j++) {
                        navUl.appendChild(list[j][1]);
                    }
                }
            }

            if (document.querySelectorAll) orderNav();
        </script>
        
        <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-69301419-1', 'auto');
  ga('send', 'pageview');
</script>

        
    </body>
</html>
