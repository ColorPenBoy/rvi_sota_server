---
layout: page
title: "API"
category: dev
date: 2015-08-26 10:30:27
---
:toc: macro

toc::[]

This is the draft documentation page for the REST API of SOTA, including
the Web Server, the Core Server, and the Resolver.

Note that all responses are sent as JSON.

=== GET /vehicles

[width="100%",cols="18%,82%",]
|================================================================
|Availability
|core, resolver

|Description
|Returns a list of all vehicle VINs in the database.

|URL
|/api/v1/vehicles

|Parameters
|None

|Success Response
a|
*Code:* 200

*Content:* A list of VINs.

[source,json]
----
[
  {
    "vin": "AAAAAAA1234567890"
  },
  {
    "vin": "BBBBBBB1234567890"
  }
]
----

|Error Response a|N/A
|================================================================

=== PUT /vehicles/:vin

[width="100%",cols="18%,82%",]
|=======================================================================
|Availability |core, resolver

|Description |Adds a vehicle VIN to the database.

|URL |/api/v1/vehicles/:vin

|URL Parameters a|
* *:vin* — A vehicle identification number to be added to the database.
Must be exactly 17 characters long, and contain only alphanumeric
characters.

|Success Response a|
*Code:* 204

*Content:* None

|Error Response a|
*Code:* 400

*Content:*
[source,json]
----
{
  "code": "invalid_entity",
  "description": "Predicate failed:(ABCDEFGHIJKLMNOP1234567890 isn't 17 letters or digits long)."
}
----

|=======================================================================

=== GET /packages

[width="100%",cols="18%,82%",]
|==============================================================
|Availability |core, resolver
|Description |Returns a list of packages.
|URL |/api/v1/packages
|Parameters |None
|Success Response a|
*Code:* 200

[source,json]
----
[
  {
    "name": "myPackage",
    "size": 11077,
    "description": "test package",
    "uri": "http://path/to/file",
    "version": "1.2.3",
    "checksum": "xgm98xdcsw22Cdr93oWKEZ7YLM0=",
    "vendor": "Acme Software"
  }
]
----

Note: Currently, the resolver returns an empty list and a *204 No Content* code for this endpoint, even though it stores package information in its database.

|Error Response a|N/A
|==============================================================

=== PUT /packages/:name/:version

[width="100%",cols="18%,82%",]
|=======================================================================
|Availability |core

|Description |Adds a package to the database.

|URL |/api/v1/packages/:name/:version

|URL Parameters a|
* *:name* — The unique name of the software package.
* *:version* — The package version, in _x.y.z_ format. __x__, __y__, and
_z_ must all contain only digits.

|Data Parameters a|
*Required:*

* *file* — The binary package file.

*Optional:*

* *description* — A short description of the package.
* *vendor* — The vendor for the software package.

|Success Response a|unknown

|Error Response a|unknown
|=======================================================================

=== PUT /packages/:name/:version

[width="100%",cols="18%,82%",]
|=======================================================================
|Availability |resolver

|Description |Adds a package to the database.

|URL |/api/v1/packages/:name/:version

|URL Parameters a|
* *:name* — The unique name of the software package.
* *:version* — The package version, in _x.y.z_ format. __x__, __y__, and
_z_ must all contain only digits.

|Data Parameters a|

*Optional:*

* *description* — A short description of the package.
* *vendor* — The vendor for the software package.

|Success Response a|unknown

|Error Response a|unknown
|=======================================================================

=== GET /resolve/:name/:version

[width="100%",cols="18%,82%",]
|=======================================================================
|Availability |resolver

|Description |Takes a package name and version, and returns a list of
VINs it applies to.

|URL |/api/v1/resolve/:name/:version

|URL Parameters a|
* *:name* — The unique name of the software package.
* *:version* — The package version, in _x.y.z_ format. __x__, __y__, and
_z_ must all contain only digits.

|Success Response a|
*Code:* 200

*Content:*

[source,json]
----

[
  [
    {
      "get": "bbbbbbb0987054321"
    },
    [
      {
        "version":"4.5.6",
        "name":"myPackage"
      }
    ]
  ],
  [
    {
      "get":"abcdefg1234567890"
    },
    [
      {
        "version":"4.5.6",
        "name":"myPackage"
      }
    ]
  ]
]
----

|Error Response a|N/A
|=======================================================================

=== GET /filters

[width="100%",cols="18%,82%",]
|=======================================================================
|Availability |resolver

|Description |Returns a list of all filters in the database.

|URL |/api/v1/filters

|Parameters |None

|Success Response a|
*Code:* 200

*Content:* A list of filters.

[source,json]
----

[
  {
    "expression": "vin_matches \"^12ABC\" AND has_component \"AcmeDVDPlayer\"",
    "name": "myFilter"
  }
]
----

|Error Response a|N/A
|=======================================================================

=== POST /filters

[width="100%",cols="18%,82%",]
|=======================================================================
|Availability |resolver

|Description |Adds a filter to the database.

|URL |/api/v1/filters

|Data Parameters a|
* *name* — A unique identifying name for the filter, between 2 and 100 alphanumeric characters in length.
* *expression* — A filter. See the link:../doc/admin-gui-user-guide.html#filter-syntax[filter syntax documentation].

|Success Response a|
*Code:* 200

*Content:*

[source,json]
----
[
  {
    "expression": "vin_matches \"^12ABC\" AND has_component \"AcmeDVDPlayer\"",
    "name": "myFilter"
  }
]
----

|Error Responses a|
* Invalid filter syntax

*Code:* 400

*Content:*
[source,json]
----
{
  "code": "invalid_entity",
  "description": "Predicate failed: (Expression failed to parse)."
}
----

* Filter name already exists

*Code:* 409

*Content:*
[source,json]
----
{
  "code": "duplicate_entry",
  "description": "Entry already exists"
}
----

|=======================================================================

=== PUT /filters/:filter

[width="100%",cols="18%,82%",]
|=======================================================================
|Availability |resolver

|Description |Modifies an existing filter

|URL |/api/v1/filters

|URL Parameters a|
* *:filter* — The name of an existing filter.

|Data Parameters a|
* *expression* - A filter. See the link:../doc/admin-gui-user-guide.html#filter-syntax[filter syntax documentation].

|Success Response a|
*Code:* 200

*Content:*

[source,json]
----
[
  {
    "expression": "vin_matches \"^12ABC\" AND has_component \"AcmeDVDPlayer\"",
    "name": "myFilter"
  }
]
----

|Error Responses a|
* Invalid filter syntax

*Code:* 400

*Content:*
[source,json]
----
{
  "code": "invalid_entity",
  "description": "Predicate failed: (Expression failed to parse)."
}
----

* Filter name doesn't exist

*Code:* 400

*Content:*
[source,json]
----
{
  "code": "missing_filter",
  "description": "Filter doesn't exist"
}
----

|=======================================================================

=== DELETE /filters/:filter

[width="100%",cols="18%,82%",]
|=======================================================================
|Availability |resolver

|Description |Deletes an existing filter

|URL |/api/v1/filters/:filter

|URL Parameters a|
* *:filter* — The name of an existing filter, between 2 and 100 alphanumeric characters in length.
* *expression* — A filter. See the link:../doc/admin-gui-user-guide.html#filter-syntax[filter syntax documentation].

|Success Response a|
*Code:* 200

*Content:* "The filter named Refined(myFilter) has been deleted."

|Error Responses a|
* Filter name doesn't exist

*Code:* 400

*Content:*
[source,json]
----
{
  "code": "missing_filter",
  "description": "Filter doesn't exist"
}
----

|=======================================================================


=== POST /validate/filter

[width="100%",cols="18%,82%",]
|=======================================================================
|Availability |resolver

|Description |Validates the syntax of a filter.

|URL |/api/v1/validate/filter

|Data Parameters a|
* *name* — A unique identifying name for the filter, between
2 and 100 alphanumeric characters in length.
* *expression* — A filter. See the link:../doc/admin-gui-user-guide.html#filter-syntax[filter syntax documentation].

|Success Response a|
*Code:* 200

*Content:* "OK"

*Note:* Only the _validity_ of the filter name is checked. As long as
the filter syntax is correct and the name is between 2 and 100
alphanumeric characters, a success response is returned, regardless of
whether a filter with this name already exists.

|Error Responses a|
*Code:* 400

*Content:*
[source,json]
----
{
  "code": "invalid_entity",
  "description": "Predicate failed: (Expression failed to parse)."
}
----

|=======================================================================

=== GET /packageFilters

[width="100%",cols="18%,82%",]
|==================================================================
|Availability |resolver
|Description |Returns a list of all package —> filter associations.
|URL |/api/v1/packageFilters
|Parameters |None
|Success Response a|
*Code:* 200

*Content:*

[source,json]
----
[
  {
    "filterName": "myFilter",
    "packageVersion": "4.5.6",
    "packageName": "myPackage"
  }
]
----
|==================================================================

=== POST /packageFilters

[width="100%",cols="18%,82%",]
|==================================================================
|Availability |resolver
|Description |Associate a filter with a package
|URL |/api/v1/packageFilters
|Data Parameters a|
* *packageName* - The name of an existing package.
* *packageVersion* - A valid version number for that package.
* *filterName* - The name of an existing filter.
|Success Response a|
*Code:* 200

*Content:*

[source,json]
----
[
  {
    "filterName": "myFilter",
    "packageVersion": "4.5.6",
    "packageName": "myPackage"
  }
]
----

|Error Response a|
*Code:* 409

*Content:*
[source,json]
----
{
  "code": "duplicate_entry",
  "description": "Entry already exists"
}
----
|==================================================================

=== DELETE /packageFiltersDelete/:packageName/:packageVersion/:filterName

[width="100%",cols="18%,82%",]
|==================================================================
|Availability |resolver
|Description |Delete a package -> filter association
|URL |/api/v1/packageFiltersDelete/:packageName/:packageVersion/:filterName
|URL Parameters a|
* *packageName* - The name of an existing package.
* *packageVersion* - A valid version number for that package.
* *filterName* - The name of an existing filter that is associated with that package name and version.
|Success Response a|
*Code:* 200

*Content:* 1

|Error Response a|
*Code:* 400

*Content:*
[source,json]
----
{
  "code": "missing_package_filter",
  "description": "Package filter doesn't exist"
}
----
|==================================================================


=== GET /packageFilters/packagesFor/:filter

[width="100%",cols="18%,82%",]
|=======================================================================
|Availability |web server, resolver

|Description |Returns a list of all packages associated with a
particular filter.

|URL |/api/v1/packageFilters/packagesFor/:filter

|URL Parameters a|
* *:filter* — A filter name.

|Success Response a|
*Code:* 200

*Content:*

[source,json]
----
[
  [
    "myPackage",
    "1.2.3"
  ],
  [
    "myPackage2",
    "2.3.4"
  ]
]
----


|Error Response a|
*Code:* 404

*Content:*
[source,json]
----
{
  "code": "missing_filter",
  "description": "Filter doesn't exist"
}
----
|=======================================================================

=== GET /packageFilters/filtersFor/:name/:version

[width="100%",cols="18%,82%",]
|=======================================================================
|Availability |resolver

|Description |Returns a list of all filters associated with a particular
package.

|URL |/api/v1/packageFilters/filtersFor/:name/:version

|URL Parameters a|
* *:name* — A package name.
* *:version* — A package version, in _x.y.z_ format. __x__, __y__, and __z__ must all exist, and contain only digits.

|Success Response a|
*Code:* 200

*Content:* A list of filters associated with the package.

[source,json]
----
[
  {
    "expression": "vin_matches \"^12ABC\" AND has_component \"AcmeDVDPlayer\"",
    "name": "myFilter"
  }
]
----

|Error Response a|
*Code:* 404

*Content:*
[source,json]
----
{
  "code": "missing_package",
  "description": "Package doesn't exist"
}
----
|=======================================================================

=== POST /install_campaigns

[width="100%",cols="18%,82%",]
|=======================================================================
|Availability |core

|Description |Create an install campaign for a package

|URL |/api/v1/install_campaigns

|Data Parameters a|
* *packageId* — An object consisting of:
  ** *:name* — A package name.
  ** *:version* — A package version, in _x.y.z_ format. __x__, __y__, and __z__ must all exist, and contain only digits.
* *priority* — `[int]` The priority order of the campaign. Lower numbers indicate higher priority.
* *startAfter* — `[dateTime]` The date on which to begin attempting to install the package.
* *endBefore* — `[dateTime]` The date before which all installations should be finished.

*Example:*
[source,json]
----
{
  "packageId": {
    "name": "myPackage",
    "version": "1.2.3"
  },
  "priority": 5,
  "startAfter": "2015-01-01T00:00:00+02:00",
  "endBefore": "2015-12-31T12:59:00+02:00"
}
----
|Success Response a|
*Code:* 200

*Content:* The created campaign, with times converted to UTC, along with a campaign ID.

[source,json]
----
{
  "priority": 5,
  "endBefore": "2015-12-31T10:59:00Z",
  "id": 10,
  "startAfter": "2014-12-31T22:00:00Z",
  "packageId": {
    "name": "myPackage",
    "version": "1.2.3"
  }
}
----

|Error Response a|
Invalid package name:

*Code:* 500

*Content:*
[source,json]
----
{
  "error": "Cannot add or update a child row: a foreign key constraint fails (`sota_core`.`installcampaign`, CONSTRAINT `install_campaign_package_id_fk` FOREIGN KEY (`packageName`, `packageVersion`) REFERENCES `Package` (`name`, `version`))"
}
----
|=======================================================================
